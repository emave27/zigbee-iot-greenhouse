<!doctype html>
<html>
<head>
  {{ turbo() }}
  <title>Greenhouse Dashboard Demo</title>
  <style>
    /*.result{
      max-width: 250px;
      border: 1px solid black;
      padding: 15px;
    }*/
    .navbar{background-color: #004225;}
    .separator{margin-top:10px;
               padding-left: 30px!important;
               padding-right: 30px!important;}
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button{
        -webkit-appearance: none;
        margin: 0;
    }

    /* Firefox */
    input[type=number] {-moz-appearance: textfield;}
  </style>
</head>
<body>
<header>
  <nav class="navbar navbar-expand-sm navbar-dark justify-content-end">
  <a class="navbar-brand">Dashboard</a>
  <span class="ml-auto"></span>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent">
  <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse flex-grow-0" id="navbarSupportedContent">
    <ul class="navbar-nav text-right">
      <li class="nav-item active">
        <a class="nav-link">Log out</a>
      </li>
    </ul>
  </div>
  </nav>
</header>
<div class="container-fluid separator">
  <div class="row">
    <div class="col-md-2">{% include "loadavg.html" %}</div>
    <div class="col-md-6">
    <h4>Current settings</h4>
    <div class="col-auto">
    <ul style="list-style-type:none">
      <li>Current temperature threshold: <span id="c_tt"></span> Â°C</li>
      <li>Current pump duty time: <span id="c_dt"></span> seconds</li>
      <li>Current update interval: <span id="c_upint"></span> seconds</li>
      <li>Upload data: <span id="c_upl"></span></li>
      <li>Mode: <span id="md"></span></li>
    </ul>
    </div>
    <h4>Update settings</h4>
    <form class="set-form" role="form" id="set-form">
      <div class="form-row align-items-center">
        <div class="col-auto pump-col" id="pump-com">Update all settings at the same time</div>
      </div>
      <div class="form-row align-items-center">
        <div class="col-auto">
          <label for="temp_t" class="form-label">Temperature threshold</label>
          <input type="number" name="temp_t" class="form-control" id="temp_t">
        </div>
        <div class="col-auto">
          <label for="pump_duty" class="form-label">Pump duty time (in seconds)</label>
          <input type="number" name="pump_d" class="form-control" id="pump_duty">
        </div>
        <div class="col-auto">
          <label for="update_int" class="form-label">Update interval (in seconds)</label>
          <input type="number" name="up_int" class="form-control" id="update_int">
        </div>
      </div>
    <div class="form-row align-items-center">
      <div class="col-auto">
        <label class="my-1 mr-2" for="up_stat">Upload data</label>
        <select class="custom-select mr-sm-2" name="upload" id="up_stat">
          <option selected value="1">Yes</option>
          <option value="0">No</option>
        </select>
      </div>
      <div class="col-auto">
        <label class="my-1 mr-2" for="mode">Mode</label>
        <select class="custom-select mr-sm-2" name="mode" id="mode">
          <option selected value="1">Auto</option>
          <option value="0">Manual</option>
        </select>
      </div>
    </div>
    <small id="warning" class="form-text text-muted">Set manual mode to manually controll fan and pump</small>
    <button type="button" class="btn btn-primary" id="upd-button">Update</button>
    </form>
    <!--<canvas id="test_chart" style="width:100%;max-width:800px"></canvas>-->
    </div>
    <div class="col-md-4">
      <h4>Manual control</h4>
      <form class="man-form" id="man-form">
      <div class="form-row align-items-center">
        <div class="col-auto pump-col" id="pump-com">
          Fan is currently: <span id="f_stat"></span> - Pump is currently: <span id="p_stat"></span>
        </div>
      </div>
      <div class="form-row align-items-center">
        <div class="col-auto fan-col" id="fan-col">
          <label class="my-1 mr-2" for="fan_stat">Fan</label>
          <select class="custom-select mr-sm-2" name="fan_stat" id="fan_stat">
            <option selected value="1">On</option>
            <option value="0">Off</option>
          </select>
        </div>
        <div class="col-auto pump-col" id="pump-com">
          <label class="my-1 mr-2" for="pump_stat">Pump</label>
          <select class="custom-select mr-sm-2" name="pump_stat" id="pump_stat">
            <option selected value="1">On</option>
            <option value="0">Off</option>
          </select>
        </div>
      </div>
      <small id="warning" class="form-text text-muted">&nbsp</small>
      <button type="button" class="btn btn-primary" id="man-button">Set</button>
      </form>
    </div>
  </div>
</div>
<footer>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
<script>
  function convert_data(in_data, is_onload){
    const data=JSON.parse(in_data);
    document.getElementById('c_dt').innerHTML=data.duty;
    document.getElementById('c_tt').innerHTML=data.thresh;
    document.getElementById('c_upint').innerHTML=data.update;

    if (data.mode==true){ document.getElementById('md').innerHTML="auto"; } 
    else { document.getElementById('md').innerHTML="manual"; }

    if (data.upload==true){ document.getElementById('c_upl').innerHTML="yes"; } 
    else { document.getElementById('c_upl').innerHTML="no"; }

    if (is_onload==true){
      if (data.fan_stat==true){ document.getElementById('f_stat').innerHTML="On"; } 
      else { document.getElementById('f_stat').innerHTML="Off"; }

      if (data.pump_stat==true){ document.getElementById('p_stat').innerHTML="On"; } 
      else { document.getElementById('p_stat').innerHTML="Off"; }
    }
  }

  function convert_manual_set(in_data){
    const data=JSON.parse(in_data);
    if (data.fan_stat==true){ document.getElementById('f_stat').innerHTML="On"; } 
    else { document.getElementById('f_stat').innerHTML="Off"; }

    if (data.pump_stat==true){ document.getElementById('p_stat').innerHTML="On"; } 
    else { document.getElementById('p_stat').innerHTML="Off"; }
  }

  $(function(){
	  $('#upd-button').click(function(){
		  $.ajax({
			  url: '/update_set',
			  data: $('#set-form').serialize(),
			  type: 'POST',
			  success: function(response){
				  console.log(response);
          convert_data(response, false);
          $('#set-form')[0].reset();
			  },
			  error: function(error){
				  console.log(error);
          $('#set-form')[0].reset();
			  }
		  });
	  });
  });

  $(function(){
    $('#man-button').click(function(){
      $.ajax({
        url: '/handle_manual',
        data: $('#man-form').serialize(),
        type: 'POST',
        success: function(response){
				  console.log(response);
          convert_manual_set(response);
			  },
			  error: function(error){
				  console.log(error);
          $('#man-form')[0].reset();
			  }
      });
    });
  });

  $(document).ready(function(){
    $.ajax({
      url: '/get_set',
      data: 'current settings',
      type: 'POST',
      success: function(response){
				console.log(response);
        convert_data(response, true);
			},
			error: function(error){
				console.log(error);
			}
    });
  });

  /*var xyValues = [
  {x:50, y:7},
  {x:60, y:8},
  {x:70, y:8},
  {x:80, y:9},
  {x:90, y:9},
  {x:100, y:9},
  {x:110, y:10},
  {x:120, y:11},
  {x:130, y:14},
  {x:140, y:14},
  {x:150, y:15}];
  
  new Chart("test_chart", {
    type: "scatter",
    data: {
      datasets: [{
        pointRadius: 4,
        pointBackgroundColor: "rgba(0,0,255,1)",
        data: xyValues
      }]
    },
    options:{
      legend: {display: false},
      scales: {
        xAxes: [{ticks: {min: 40, max:160}}],
        yAxes: [{ticks: {min: 6, max:16}}],
      }
    }
  });*/
</script>
</footer>
</body>
</html>
